name: Build, Commit dist, and Deploy Pages

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'dist/**'          # 無限ループ回避（dist更新で再トリガーしない）
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write      # ← dist をコミットするために必要
      pages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true   # ← GITHUB_TOKEN で push するために必要
      - uses: actions/setup-node@v4
        with: { node-version: 20 }

      - run: npm ci || npm i
      - run: npm run build            # dist/manifest.json と dist/bundles/** を生成

      - name: Commit dist to repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A dist
          if git diff --cached --quiet; then
            echo "No dist changes to commit."
          else
            git commit -m "chore: build dist [skip ci]"   # 追加のループ回避
            git push
          fi

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    steps:
      - uses: actions/deploy-pages@v4
